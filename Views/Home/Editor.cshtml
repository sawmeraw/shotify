@{
    ViewData["Title"] = "Image Editor";
    ViewData["PageHeading"] = "Crop Images";
}

<div class="mt-4 py-2 px-4" id="crop-container">
    <div class="row">
        <div class="col-md-4">
            <div class="fs-4 text-black fw-semibold">
                <p>Crop images</p>
            </div>
            <div id="drop-zone" class="d-flex justify-content-center align-items-center mb-3">
                <p class="text-muted">Drag & Drop Images or <span style="color: #00a8a0">Click Here</span></p>
            </div>
            
            <input type="file" id="file-input" accept="image/jpeg, image/png" multiple style="display: none;">

            <div class="d-flex gap-4 mb-4 ps-4">
                <button id="process-btn" class="btn btn-dark fw-semibold rounded-md" disabled>Process Images</button>
                <button id="clear-btn" class="btn btn-dark fw-semibold rounded-md">Clear Preview</button>
            </div>
        </div>

        <div class="col-md-8 pt-4 px-4">
            <p class="fs-4 text-black fw-semibold">Image Preview</p>
            <div id="initial-preview-container" class="preview-area mb-4">
                <p class="text-muted text-center">No images dropped yet.</p>
            </div>
        </div>
    </div>
</div>

<div id="processed-preview-container" class="mt-2 px-4 py-2">
    <h3 class="mt-2 fs-4 text-black">Processed Images</h3>
    
</div>

@section Scripts{

    <script type="module">
        import {processImage, fileToDataUrl} from "/js/cropper.js";

        if (!window.App) {
            window.App = {}
        }

        window.App = {
            uploadedFiles: [],
            fileURLs: []
        };

        const $dropZone = $('#drop-zone');
        const $fileInput = $('#file-input');
        const $initialPreview = $('#initial-preview-container');
        const $processBtn = $('#process-btn');
        const $clearBtn = $('#clear-btn');

        // 2. RENDERING FUNCTION
        function renderInitialPreviews() {
            if (window.App.fileURLs.length === 0) {
                $initialPreview.html('<p class="text-muted text-center">No images dropped yet.</p>');
                $processBtn.prop('disabled', true);
                return;
            }

            let html = '';
            window.App.fileURLs.forEach(url => {
                html += `
                    <div class="image-preview-item" title="Click to view full image">
                        <img src="${url}" alt="Image Preview">
                    </div>
                `;
            });
            $initialPreview.html(html);
            $processBtn.prop('disabled', false);
        }

        function handleFiles(files) {
            window.App.uploadedFiles = [];
            window.App.fileURLs = [];

            $.each(files, function(i, file) {
                if (file.type === 'image/jpeg' || file.type === 'image/png') {
                    window.App.uploadedFiles.push(file);
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        window.App.fileURLs.push(e.target.result);
                        if (window.App.fileURLs.length === window.App.uploadedFiles.length) {
                            renderInitialPreviews();
                        }
                    };
                    reader.readAsDataURL(file);
                } else {
                    console.warn(`File "${file.name}" ignored. Only JPEG and PNG are accepted.`);
                }
            });
            
            if (window.App.uploadedFiles.length === 0) {
                renderInitialPreviews();
            }
        }

        $(document).ready(function() {
            $dropZone.on('click', function() {
                $fileInput.click();
            });

            $fileInput.on('change', function() {
                if (this.files.length > 0) {
                    handleFiles(this.files);
                }
            });

            $dropZone.on('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).addClass('drag-over');
            });

            $dropZone.on('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).removeClass('drag-over');
            });

            $dropZone.on('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log("drop triggered.");
                $(this).removeClass('drag-over');
                const files = e.originalEvent.dataTransfer.files;
                handleFiles(files);
            });

            $clearBtn.on('click', function() {
                window.App.uploadedFiles = [];
                window.App.fileURLs = [];
                $fileInput.val(''); // Clear file input value
                $('#processed-preview-container').html('<p class="text-muted text-center">Processed images will show up here.</p>');
                renderInitialPreviews();
            });

            $processBtn.on('click', function() {
                if (window.App.uploadedFiles.length === 0) {
                    alert('Please upload images first!');
                    return;
                }
                
                // --- DUMMY PROCESSING LOGIC START ---
                console.log('Processing Images:', window.App.uploadedFiles.map(f => f.name));
                
                // Simulate displaying processed images (for now, just reuse the initial previews)
                let processedHtml = '<h5>Processed Successfully (Dummy)</h5>';
                window.App.fileURLs.forEach((url, index) => {
                    processedHtml += `
                        <div class="image-preview-item">
                            <img src="${url}" alt="Processed Image ${index + 1}">
                            <a href="${url}" download="processed-image-${index + 1}.png" class="btn btn-success btn-sm mt-1" style="position: absolute; bottom: 0; right: 0;">
                                <i class="bi bi-download"></i> Download
                            </a>
                        </div>
                    `;
                });
                
                $('#processed-preview-container').html(processedHtml);
                // --- DUMMY PROCESSING LOGIC END ---
                
                // NOTE: This is where you will eventually call your Preact/Vite bundle function.
                // e.g., window.PreactCropperApp.processImages(window.App.uploadedFiles);
            });
        });
    </script>
}
