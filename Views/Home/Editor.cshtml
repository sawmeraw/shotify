@{
    ViewData["Title"] = "Image Editor";
    ViewData["PageHeading"] = "Crop Images";
}

<div class="mt-4 py-2 px-4" id="crop-container">
    <div class="row">
        <div class="col-md-4 pt-4">
            <div class="fs-4 text-black fw-semibold">
                <p>Upload Images</p>
            </div>
            <div id="drop-zone" class="d-flex justify-content-center align-items-center mb-3">
                <p class="text-muted">Drag & Drop Images or <span style="color: #00a8a0">Click Here</span></p>
            </div>
            
            <input type="file" id="file-input" accept="image/jpeg, image/png" multiple style="display: none;">

            <div class="d-flex gap-4 mb-4 ps-4">
                <button id="process-btn" class="btn btn-dark fw-semibold rounded-md" disabled>Process Images</button>
                <button id="clear-btn" class="btn btn-dark fw-semibold rounded-md">Clear Preview</button>
            </div>
        </div>

        <div class="col-md-8 pt-4 px-4">
            <p class="fs-4 text-black fw-semibold">Image Preview</p>
            <div id="initial-preview-container" class="preview-area mb-4">
                <p class="text-muted text-center">No images dropped yet.</p>
            </div>
        </div>
    </div>
</div>

<div id="edited-preview-container" class="mt-2 px-4 py-2">
    <div class="d-flex gap-4">
        <h3 class="mt-2 fs-4 text-black fw-semibold">Processed Images</h3>
        <button id="processed-download-btn" class="btn btn-dark fw-semibold rounded-md py-1 px-3" disabled>Download</button>
    </div>
    <div id="processed-preview-container" class="mt-4">

    </div>
    
</div>

@section Scripts{

    <script type="module">
        import {processImage, fileToDataUrl, randomString} from "/js/cropper.js";

        if (!window.App) {
            window.App = {}
        }

        window.App = {
            uploadedFiles: [],
            fileURLs: [],
            processedFileUrls : []
        };

        const $dropZone = $('#drop-zone');
        const $fileInput = $('#file-input');
        const $initialPreview = $('#initial-preview-container');
        const $processBtn = $('#process-btn');
        const $downloadBtn = $('#processed-download-btn');
        const $clearBtn = $('#clear-btn');

        // 2. RENDERING FUNCTION
        function renderInitialPreviews() {
            if (window.App.fileURLs.length === 0) {
                $initialPreview.html('<p class="text-muted text-center">No images dropped yet.</p>');
                $processBtn.prop('disabled', true);
                return;
            }

            let html = '';
            window.App.fileURLs.forEach(url => {
                html += `
                    <div class="image-preview-item" title="Click to view full image">
                        <img src="${url}" alt="Image Preview">
                    </div>
                `;
            });
            $initialPreview.html(html);
            $processBtn.prop('disabled', false);
        }

        function handleFiles(files) {
            window.App.uploadedFiles = [];
            window.App.fileURLs = [];

            $.each(files, function(i, file) {
                if (file.type === 'image/jpeg' || file.type === 'image/png') {
                    window.App.uploadedFiles.push(file);
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        window.App.fileURLs.push(e.target.result);
                        if (window.App.fileURLs.length === window.App.uploadedFiles.length) {
                            renderInitialPreviews();
                        }
                    };
                    reader.readAsDataURL(file);
                } else {
                    console.warn(`File "${file.name}" ignored. Only JPEG and PNG are accepted.`);
                }
            });
            
            if (window.App.uploadedFiles.length === 0) {
                renderInitialPreviews();
            }
        }

        async function processFiles(){
            const processedFiles = await Promise.all(
                window.App.uploadedFiles.map(async(file)=>{
                    const processedImage = await processImage(file);
                    return processedImage;
                })
            );

            const processedImageUrls = await Promise.all(
                processedFiles.map(async (file)=>{
                    return await fileToDataUrl(file);
                })
            )

            window.App.processedFileUrls = processedImageUrls;
        }


        function handleDownloadProcessedFiles(){
            if(window.App.processedFileUrls.length == 0){
                alert("No processed files to download.");
            }

            window.App.processedFileUrls.forEach((url, index)=>{
                console.log(url);
                const link = document.createElement("a");
                link.href = url;
                link.download = `shotify-${randomString(4)}.jpeg`;
                link.click();
            })
        }

        $(document).ready(function() {
            $dropZone.on('click', function() {
                $fileInput.click();
            });

            $fileInput.on('change', function() {
                if (this.files.length > 0) {
                    handleFiles(this.files);
                }
            });

            $dropZone.on('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).addClass('drag-over');
            });

            $dropZone.on('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).removeClass('drag-over');
            });

            $dropZone.on('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).removeClass('drag-over');
                const files = e.originalEvent.dataTransfer.files;
                handleFiles(files);
            });

            $clearBtn.on('click', function() {
                window.App.uploadedFiles = [];
                window.App.fileURLs = [];
                $fileInput.val('');
                $('#processed-preview-container').html('<p class="text-muted text-center">Processed images will show up here.</p>');
                $downloadBtn.prop('disabled', true);
                renderInitialPreviews();
            });

            $downloadBtn.on('click', handleDownloadProcessedFiles);

            $processBtn.on('click', async function() {
                if (window.App.uploadedFiles.length === 0) {
                    alert('Please upload images first!');
                    return;
                }
                
                await processFiles();
                $downloadBtn.prop('disabled', false);
                
                let processedHtml = '';
                window.App.processedFileUrls.forEach((url, index) => {
                    processedHtml += `
                        <div class="image-preview-item">
                            <img src="${url}" alt="Processed Image ${index + 1}">
                        </div>
                    `;
                });
                
                $('#processed-preview-container').html(processedHtml);
                // --- DUMMY PROCESSING LOGIC END ---
                
                // NOTE: This is where you will eventually call your Preact/Vite bundle function.
                // e.g., window.PreactCropperApp.processImages(window.App.uploadedFiles);
            });
        });
    </script>
}
